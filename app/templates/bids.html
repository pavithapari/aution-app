{% extends "base.html" %}
{% block title %}Live Auction{% endblock %}

{% block content %}
<div class="container mt-5">
  <div class="card shadow-lg p-4 mb-5 bg-white rounded">
    <h2 class="mb-4 text-center text-primary">ğŸ¯ Live Auction Room</h2>

    <div class="text-center">
      <img src="{{ image }}" alt="Auction Item" class="img-fluid rounded shadow" style="max-width: 300px;" />
    </div>

    <div class="mt-4 text-center">
      <p class="fs-5">
        Highest Bid: â‚¹<span id="highestBid" class="fw-bold text-danger">{{ initial_bid }}</span><br>
        by <span id="highestBidder" class="text-dark">{{ initial_bidder if initial_bidder else "None" }}</span>
      </p>

      <input type="text" id="username" placeholder="Your name" class="form-control mb-2"
             value="{{ current_user.username if current_user else '' }}" readonly />
      <input type="number" id="bidAmount" placeholder="Your bid" class="form-control mb-2" />
      <button onclick="placeBid()" class="btn btn-success btn-lg">ğŸ’¸ Place Bid</button>

      <p id="message" class="mt-3 text-danger fw-semibold"></p>
      <p id="auctionStatus" class="mt-3 fw-bold text-success fs-5"></p>
    </div>

    <div id="bidHistory" class="mt-4">
      <h5 class="text-center">ğŸ“œ Recent Bids</h5>
      <ul class="list-group" style="max-height: 200px; overflow-y: auto;"></ul>
    </div>
  </div>
</div>

<!-- Socket.IO & Confetti -->
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script>
  const socket = io();
  const itemId = "{{ item_id }}";

  socket.emit('joinAuction', { image_id: itemId });

  socket.on('bidUpdate', ({ highest_bid, highest_bidder }) => {
    document.getElementById('highestBid').textContent = highest_bid;
    document.getElementById('highestBidder').textContent = highest_bidder || 'None';
    document.getElementById('message').textContent = '';

    const bidHistory = document.querySelector('#bidHistory ul');
    const newEntry = document.createElement('li');
    newEntry.className = 'list-group-item';
    newEntry.textContent = `${highest_bidder} bid â‚¹${highest_bid}`;
    bidHistory.prepend(newEntry);
  });

  socket.on('bidRejected', msg => {
    document.getElementById('message').textContent = msg;
  });

  socket.on('auctionEnded', ({ winner, final_bid }) => {
    const status = document.getElementById('auctionStatus');
    status.innerHTML = `
      ğŸ‰ <span class="text-warning">Auction Ended!</span><br>
      ğŸ† Winner: <strong>${winner || 'No one'}</strong><br>
      ğŸ’° Final Bid: â‚¹${final_bid || 0}
    `;
    document.getElementById('bidAmount').disabled = true;
    document.querySelector('button').disabled = true;

    confetti({
      particleCount: 150,
      spread: 70,
      origin: { y: 0.6 }
    });
  });

  function placeBid() {
    const username = document.getElementById('username').value;
    const amount = parseFloat(document.getElementById('bidAmount').value);
    const currentBid = parseFloat(document.getElementById('highestBid').textContent);

    if (isNaN(amount) || amount <= currentBid) {
      document.getElementById('message').textContent = 'Please enter a valid bid higher than the current one.';
      return;
    }

    socket.emit('newBid', { image_id: itemId, username, amount });
  }
</script>
{% endblock %}