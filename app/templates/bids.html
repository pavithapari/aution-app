{% extends "base.html" %}
{% block title %}Live Auction{% endblock %}

{% block content %}
<div class="container mt-5">
  <h2 class="mb-4 text-center">Live Auction Room</h2>
  <div class="text-center">
    <img src="{{ image }}" alt="Auction Item" class="img-fluid rounded shadow" style="max-width: 300px;" />
  </div>

  <div class="mt-4 text-center">
    <p>
      Highest Bid: ₹<span id="highestBid">{{ initial_bid }}</span>
      by <span id="highestBidder">{{ initial_bidder if initial_bidder else "None" }}</span>
    </p>

    <input type="text" id="username" placeholder="Your name" class="form-control mb-2"
           value="{{ current_user.username if current_user else '' }}" readonly />
    <input type="number" id="bidAmount" placeholder="Your bid" class="form-control mb-2" />
    <button onclick="placeBid()" class="btn btn-primary">Place Bid</button>

    <p id="message" class="mt-3 text-danger"></p>
    <p id="auctionStatus" class="mt-3 fw-bold text-success"></p>
  </div>
</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
  const socket = io();
  const itemId = "{{ item_id }}";

  socket.emit('joinAuction', { image_id: itemId });

  socket.on('bidUpdate', ({ highest_bid, highest_bidder }) => {
    document.getElementById('highestBid').textContent = highest_bid;
    document.getElementById('highestBidder').textContent = highest_bidder || 'None';
    document.getElementById('message').textContent = '';
  });

  socket.on('bidRejected', msg => {
    document.getElementById('message').textContent = msg;
  });

  socket.on('auctionEnded', ({ winner, final_bid }) => {
    document.getElementById('auctionStatus').textContent =
      `Auction Ended! Winner: ${winner || 'No one'} with ₹${final_bid || 0}`;
    document.getElementById('bidAmount').disabled = true;
  });

  function placeBid() {
    const username = document.getElementById('username').value;
    const amount = document.getElementById('bidAmount').value;
    socket.emit('newBid', { image_id: itemId, username, amount });
  }
</script>
{% endblock %}
