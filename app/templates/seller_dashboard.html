{% extends "base.html" %}
{% block title %}Seller Dashboard{% endblock %}

{% block content %}

<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold text-primary" href="#">Auction App</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
            data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
            aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item">
          <a class="nav-link active" aria-current="page" href="{{ url_for('main.home') }}">Home</a>
        </li>
      </ul>
      <div class="d-flex ms-auto">
        <a class="btn btn-outline-secondary me-2" href="{{ url_for('main.home') }}">Buyers</a>
          <a class="btn btn-outline-primary me-2" href="{{ url_for('sellers.logout') }}">Logout</a>
      </div>
    </div>
  </div>
</nav>



<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-primary">📦 Your Auction Items</h2>
    <a href="{{ url_for('sellers.add_item') }}" class="btn btn-success">➕ Add New Auction</a>
  </div>

  <div class="row">
    {% for item in items %}
    <div class="col-md-4 mb-4">
      <div class="card shadow-sm h-100">
        <div class="bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
          <img src="{{ item.img }}" alt="{{ item.name }}"
               style="max-height: 100%; max-width: 100%; object-fit: contain;" />
        </div>
        <div class="card-body d-flex flex-column">
          <h5 class="card-title text-center text-dark">{{ item.name }}</h5>
          <p class="mb-1">💰 Base Price: ₹{{ item.base_price }}</p>
          <p class="mb-1">📈 Current Price: ₹<span id="price-{{ item.id }}">{{ item.curr_price }}</span></p>
          <p class="mb-2">
            🟢 Status:
            <span id="status-{{ item.id }}">
              {% if item.status == 'active' %}
                <span class="badge bg-success">Active</span>
              {% else %}
                <span class="badge bg-secondary">Closed</span>
                {% if item.winner_id %}
                  {% set winner = Buyers.query.get(item.id) %}
                  <br>🏆 Winner: <strong>{{ winner.username if winner else "N/A" }}</strong>
                {% endif %}
              {% endif %}
            </span>
          </p>

          <div class="mt-auto">
            {% if item.status == 'active' %}
            <form method="POST" action="{{ url_for('sellers.end_auction', item_id=item.id) }}">
              <button type="submit" class="btn btn-danger w-100">🛑 End Auction</button>
            </form>
            {% else %}
            <button class="btn btn-outline-secondary w-100" disabled>✅ Auction Ended</button>
            {% endif %}

            <a href="{{ url_for('sellers.edit_item', item_id=item.id) }}" class="btn btn-warning w-100 mt-2">✏️ Edit</a>
            <a href="{{ url_for('sellers.delete_item', item_id=item.id) }}" class="btn btn-outline-danger w-100 mt-2"
               onclick="return confirm('Are you sure you want to delete this item?');">🗑️ Delete</a>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endblock %}

<!-- Real-time updates and celebration -->
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script>
  const socket = io();

  socket.on('bidUpdate', ({ item_id, highest_bid }) => {
    const priceEl = document.getElementById(`price-${item_id}`);
    if (priceEl) {
      priceEl.textContent = highest_bid;
    }
  });

  socket.on('auctionEnded', ({ item_id, winner, final_bid }) => {
    const statusEl = document.getElementById(`status-${item_id}`);
    if (statusEl) {
      statusEl.innerHTML = `
        <span class="badge bg-secondary">Closed</span><br>
        🏆 Winner: <strong>${winner || "None"}</strong><br>
        💰 Final Bid: ₹${final_bid || 0}
      `;
      confetti({
        particleCount: 120,
        spread: 70,
        origin: { y: 0.6 }
      });
    }
  });
</script>